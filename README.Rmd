---
title: "TonoDB analyses"
author: "Steven Moran and Lilja Maria Sæbø\n"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r, message=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(xtable)
```

# Data

Load the [CLDF data](https://github.com/cldf-datasets/tonodb/).

```{r, message=FALSE}
values <- 
  read_csv(url('https://raw.githubusercontent.com/cldf-datasets/tonodb/main/cldf/values.csv'))
languages <- 
  read_csv(url('https://raw.githubusercontent.com/cldf-datasets/tonodb/main/cldf/languages.csv'))
contributions <- 
  read_csv(url('https://raw.githubusercontent.com/cldf-datasets/tonodb/main/cldf/contributions.csv'))
parameters <- 
  read_csv(url('https://raw.githubusercontent.com/cldf-datasets/tonodb/main/cldf/parameters.csv'))
```


# Descriptive stats

We have this many languages in our sample.

```{r}
nrow(languages)
```

And this many observations.

```{r}
nrow(values)
```

Let's map our data points. We note some rows are removed because the lat/long figures are NA due to them being listed as dialects or language families.

```{r}
ggplot(data=languages, aes(x=Longitude, y=Latitude)) + 
  borders("world", colour="gray50", fill="gray50") + 
  geom_point() +
  theme_bw()
```

These are the missing data points for geographic location.

```{r}
languages %>% filter(is.na(Latitude)) %>% select(ID, Name, Macroarea, Latitude, Longitude) %>% kable()
```

We've gone through by hand and added approximate geocoordinates for visualization purposes, e.g., using Glottolog's Swedish latitude and longitude for North Germanic.

Merge in the hand attributed geocoordinates.

```{r}
# There must be a saner way to do this!
hc <- read_csv('hand_coordinates.csv')
tmp <- left_join(languages, hc, by=c("ID"="ID", "Name"="Name"))
tmp <- tmp %>% mutate(Latitude.x = coalesce(Latitude.x, Latitude.y))
tmp <- tmp %>% mutate(Longitude.x = coalesce(Longitude.x, Longitude.y))
tmp <- tmp %>% select(-Latitude.y, Longitude.y)
tmp <- tmp %>% rename(Latitude = Latitude.x)
tmp <- tmp %>% rename(Longitude = Longitude.x)
languages <- tmp
```

Redo the map.

```{r}
ggplot(data=languages, aes(x=Longitude, y=Latitude)) + 
  borders("world", colour="gray50", fill="gray50") + 
  geom_point() +
  theme_bw()
```

Here we can add some color by language family.

```{r}
ggplot(data=languages, aes(x=Longitude, y=Latitude, color=family_id)) + 
  borders("world", colour="gray50", fill="gray50") + 
  geom_point() +
  theme_bw()
```

How many data points per macroarea? (Note again several NAs.)

```{r}
table(languages$Macroarea, exclude=FALSE)
```

Some macroareas are missing, e.g., languages that don't have Glottocodes or are family level codes.

```{r}
languages %>% filter(is.na(Macroarea))
# tmp <- languages %>% filter(is.na(Macroarea)) %>% select(ID, Name, Macroarea)
# write_csv(tmp, 'get_macroareas.csv')

# There must be a saner way to do this!
hc <- read_csv('hand_macroareas.csv')
tmp <- left_join(languages, hc, by=c("ID"="ID", "Name"="Name"))
tmp <- tmp %>% mutate(Macroarea.x = coalesce(Macroarea.x, Macroarea.y))
tmp <- tmp %>% select(-Macroarea.y)
tmp <- tmp %>% rename(Macroarea = Macroarea.x)
languages <- tmp
table(languages$Macroarea, exclude = FALSE)
```




# Analyses

Recreate some of the tables.

First merge the tonodb tables.

```{r}
tonodb <- left_join(values, languages, by=c("Language_ID"="ID"))
tonodb %>% filter(is.na(family_id))
```

```{r}
x <- tonodb %>% select(Macroarea, Language_ID) %>% distinct() %>% group_by(Macroarea) %>% summarise(Languages = n())
y <- tonodb %>% select(Macroarea, family_id) %>% distinct() %>% group_by(Macroarea) %>% summarize(Families = n())
z <- tonodb %>% select(Macroarea, TriggeringContext) %>% group_by(Macroarea) %>% summarize(`Cases of tonogenesis` = n())

tmp <- left_join(x, y)
tmp <- left_join(tmp, z)
tmp %>% kable()

# Still getting some NAs, let's drop them
table(tonodb$family_id, exclude = FALSE)
tmp <- tmp %>% filter(!is.na(Macroarea))
tmp %>% kable()

# TODO: comment this out for the SI
print(xtable(tmp, type = "latex", caption="Distribution of the languages, families and cases of tonogenesis across different areas"), include.rownames=FALSE)
```

Number of languages in different families.

```{r, warning=FALSE, message=FALSE}
tmp <- tonodb %>% select(family_id, LanguageVariety) %>% distinct() %>% arrange(family_id, LanguageVariety) %>% group_by(family_id) %>% summarize(`Number of varieties` = n(), Languages = str_c(LanguageVariety, collapse=", "))

# We need the Glottolog family names
glottolog <- read_csv('data/languoid.csv')
families <- glottolog %>% filter(id %in% tmp$family_id) %>% select(id, name)
tmp <- left_join(tmp, families, by=c("family_id"="id"))
tmp <- tmp %>% select(name, `Number of varieties`, Languages)
tmp <- tmp %>% rename(Family = name)

tmp %>% kable()

# TODO: comment this out for the SI
print(xtable(tmp, type = "latex", caption="Number of languages in different language families"), include.rownames=FALSE)
```

Cases of tonogenesis sorted by triggering context.

```{r}
x <- tonodb %>% group_by(Type) %>% summarize(`Cases of tonogenesis` = n()) %>% arrange()
y <- tonodb %>% select(Type, LanguageVariety) %>% distinct() %>% group_by(Type) %>% summarize(`Number of languages` = n()) %>% arrange()
tmp <- left_join(x, y)
tmp %>% kable()

# Remove NAs
tmp <- tmp %>% filter(!is.na(Type))
tmp %>% kable()

# TODO: comment this out for the SI
print(xtable(tmp, type = "latex", caption="Cases of tonogenesis by category"), include.rownames=FALSE)
```

Tonogenesis conditioned by voiced and voiceless (unaspirated) obstruents.

```{r}
table(tonodb$EffectOnPitch)
table(tonodb$Onset)
tonodb %>% select(EffectOnPitch, Onset) %>% filter(grepl("voiced", Onset))
```


```{r}
table(tonodb$Type)

```



<!-- -------------------------------------------------------------------------- -->

Tonogenesis triggered by onsets in the DoTE.

```{r}
table(tonodb$Onset, tonodb$EffectOnPitch) %>% kable()
```

The effect of voicing on tone in the DoTE (number of languages). TODO: double check, Lilja.

```{r}
tmp <- tonodb %>% filter(Onset %in% c('voiceless', 'voiced'))
table(tmp$Onset, tmp$EffectOnPitch) %>% kable()
```

Tonogenesis triggered by codas in the DoTE (number of cases of tonogenesis).

```{r}
table(tonodb$Coda, tonodb$EffectOnPitch) %>% kable()
```

Tonogenesis triggered by vowel quantity in the DoTE. TODO: these are all zeros.

```{r}
table(tonodb$Nucleus, tonodb$EffectOnPitch) %>% kable()
```

Tables to add:

- Distribution of the languages, families and cases of tonogenesis across different areas

Area
Number of varieties
Number of families[1]
Number of instances of tonogenesis
Asia
39
9
149


- Number of languages in different language families

Family
Number of varieties
Languages
Afroasiatic
2
Iraqw, Podoko

- Cases of tonogenesis by category

 
Number of cases of tonogenesis
Number of Languages
Onset
126
37


- Tonogenesis conditioned by voiced and voiceless (unaspirated) obstruents.[2]

 
Higher tone
Lower tone
Voiced
5
21

- The relative height of voiced, voiceless aspirated and voiceless unaspirated onsets

- The relative height of voiceless aspirated and unaspirated onsets (based on table above)

- Tonogenesis triggered by coda consonants

 
Level
Rising
Falling
Glottal stop
1
3
5
Voiceless fricative (especially /h/)
2
 
5










